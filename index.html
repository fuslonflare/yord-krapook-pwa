<!DOCTYPE html>
<html>
<head>
<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Money Tracker</title>
<link rel="manifest" href="/yord-krapook-pwa/manifest.json"> <!-- PWA Manifest Link -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f0f2f5;
    color: #333;
  }
  .container-fluid {
    max-width: 1200px;
  }
  .card {
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  .btn {
    border-radius: 0.5rem;
  }
  .nav-link.active {
    background-color: #0d6efd !important;
    color: white !important;
    border-radius: 0.5rem;
  }
  .form-control, .form-select {
    border-radius: 0.5rem;
  }
  .table-responsive {
    border-radius: 0.75rem;
    overflow-x: auto;
  }
  .table th, .table td {
    vertical-align: middle;
  }
  .modal-content {
    border-radius: 1rem;
  }
  .color-box {
    width: 24px;
    height: 24px;
    border-radius: 0.25rem;
    border: 1px solid #ccc;
    display: inline-block;
    vertical-align: middle;
  }
  .icon-preview {
    font-size: 1.5rem;
    vertical-align: middle;
    margin-right: 0.5rem;
  }
  .transaction-group-header {
    background-color: #e9ecef;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: bold;
  }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }
  .calendar-day {
    border: 1px solid #e0e0e0;
    border-radius: 0.5rem;
    padding: 0.5rem;
    text-align: center;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    cursor: pointer;
    background-color: #fff;
  }
  .calendar-day.current-day {
    border: 2px solid #0d6efd;
    box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
  }
  .calendar-day.empty {
    background-color: #f8f9fa;
    cursor: default;
  }
  .calendar-day-date {
    font-weight: bold;
    font-size: 1.1em;
  }
  .calendar-income {
    color: green;
    font-weight: bold;
  }
  .calendar-expense {
    color: red;
    font-weight: bold;
  }
  .search-results-modal .modal-body {
    max-height: 70vh;
    overflow-y: auto;
  }
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    flex-direction: column;
  }
  .spinner-border {
    width: 3rem;
    height: 3rem;
  }
</style>
</head>
<body class="p-4">

<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3 text-lg text-primary">กำลังโหลดข้อมูล...</p>
</div>

<div class="container-fluid">
  <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">My Money Tracker</h1>

  <div class="bg-white p-4 rounded-xl shadow-md mb-6">
    <ul class="nav nav-pills nav-fill" id="mainTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">ภาพรวม</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab" aria-controls="transactions" aria-selected="false">รายการธุรกรรม</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="wallets-tab" data-bs-toggle="tab" data-bs-target="#wallets" type="button" role="tab" aria-controls="wallets" aria-selected="false">กระเป๋า</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab" aria-controls="categories" aria-selected="false">หมวดหมู่</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tags-tab" data-bs-toggle="tab" data-bs-target="#tags" type="button" role="tab" aria-controls="tags" aria-selected="false">แท็ก</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="currencies-tab" data-bs-toggle="tab" data-bs-target="#currencies" type="button" role="tab" aria-controls="currencies" aria-selected="false">สกุลเงิน</button>
      </li>
    </ul>
  </div>

  <div class="tab-content" id="mainTabContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
        <div class="card p-4">
          <h5 class="font-semibold text-lg mb-2">ยอดคงเหลือรวมทั้งหมด</h5>
          <p class="text-3xl font-bold text-blue-600" id="totalOverallBalance">0.00 THB</p>
        </div>
        <div class="card p-4">
          <h5 class="font-semibold text-lg mb-2">สรุปธุรกรรม (วันนี้)</h5>
          <p class="text-green-600">รายรับ: <span id="summaryDailyIncome">0.00</span></p>
          <p class="text-red-600">รายจ่าย: <span id="summaryDailyExpense">0.00</span></p>
          <p class="text-gray-600">โอนเงิน: <span id="summaryDailyTransfer">0.00</span></p>
          <div class="mt-2">
            <button class="btn btn-sm btn-outline-primary" onclick="loadOverviewData('daily')">รายวัน</button>
            <button class="btn btn-sm btn-outline-primary" onclick="loadOverviewData('weekly')">รายสัปดาห์</button>
            <button class="btn btn-sm btn-outline-primary" onclick="loadOverviewData('monthly')">รายเดือน</button>
          </div>
        </div>
        <div class="card p-4">
          <h5 class="font-semibold text-lg mb-2">รายจ่ายสูงสุด 5 อันดับ</h5>
          <ul id="top5ExpensesList" class="list-unstyled">
            <li>- ไม่มีข้อมูล -</li>
          </ul>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="card p-4">
          <h5 class="font-semibold text-lg mb-2">ยอดคงเหลือแต่ละกระเป๋า</h5>
          <div id="walletBalancesList">
            <p>- ไม่มีข้อมูล -</p>
          </div>
        </div>
        <div class="card p-4">
          <h5 class="font-semibold text-lg mb-2">รายการธุรกรรม 10 รายการล่าสุด</h5>
          <div id="latestTransactionsList">
            <p>- ไม่มีข้อมูล -</p>
          </div>
        </div>
      </div>

      <div class="card p-4 mb-4">
        <h5 class="font-semibold text-lg mb-2">ปฏิทินธุรกรรม</h5>
        <div class="flex justify-between items-center mb-3">
          <button class="btn btn-outline-secondary" id="prevMonthBtn"><i class="bi bi-chevron-left"></i></button>
          <span class="font-bold text-xl" id="currentMonthYear"></span>
          <button class="btn btn-outline-secondary" id="nextMonthBtn"><i class="bi bi-chevron-right"></i></button>
          <select id="calendarWalletFilter" class="form-select w-auto">
            <option value="">ทุกกระเป๋า</option>
          </select>
        </div>
        <div class="calendar-grid text-center font-bold mb-2">
          <div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div>ส</div><div>อา</div>
        </div>
        <div id="calendarGrid" class="calendar-grid">
          <!-- Calendar days will be rendered here -->
        </div>
      </div>
    </div>

    <!-- Transactions Tab -->
    <div class="tab-pane fade" id="transactions" role="tabpanel" aria-labelledby="transactions-tab">
      <div class="card p-4 mb-4">
        <h5 class="font-semibold text-lg mb-3">เพิ่มรายการธุรกรรม</h5>
        <form id="transactionForm">
          <input type="hidden" id="transactionId" value="">
          <div class="mb-3">
            <label class="form-label">ประเภทธุรกรรม</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="transactionType" id="typeIncome" value="Income" checked>
                <label class="form-check-label" for="typeIncome">รายรับ</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="transactionType" id="typeExpense" value="Expense">
                <label class="form-check-label" for="typeExpense">รายจ่าย</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="transactionType" id="typeTransfer" value="Transfer">
                <label class="form-check-label" for="typeTransfer">โอนเงิน</label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="sourceWallet" class="form-label">กระเป๋าต้นทาง <span class="text-danger">*</span></label>
            <select class="form-select" id="sourceWallet" required></select>
          </div>

          <div class="mb-3" id="destinationWalletGroup">
            <label for="destinationWallet" class="form-label">กระเป๋าปลายทาง <span class="text-danger">*</span></label>
            <select class="form-select" id="destinationWallet"></select>
          </div>

          <div class="mb-3" id="categoryGroup">
            <label for="category" class="form-label">หมวดหมู่ <span class="text-danger">*</span></label>
            <select class="form-select" id="category"></select>
          </div>

          <div class="mb-3">
            <label for="amount" class="form-label">จำนวนเงิน <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="amount" min="0" required>
          </div>

          <div class="mb-3">
            <label for="itemName" class="form-label">ชื่อรายการ</label>
            <input type="text" class="form-control" id="itemName" list="recentItemNames">
            <datalist id="recentItemNames"></datalist>
          </div>

          <div class="mb-3">
            <label for="transactionDateTime" class="form-label">วันที่-เวลา <span class="text-danger">*</span></label>
            <input type="datetime-local" class="form-control" id="transactionDateTime" required>
          </div>

          <div class="mb-3">
            <label for="tags" class="form-label">แท็ก</label>
            <select class="form-select" id="tags" multiple></select>
            <input type="text" class="form-control mt-2" id="newTagInput" placeholder="เพิ่มแท็กใหม่ (กด Enter)">
          </div>

          <div class="mb-3">
            <label for="imageUpload" class="form-label">รูปภาพ (สูงสุด 3 รูป)</label>
            <input type="file" class="form-control" id="imageUpload" accept="image/*" multiple>
            <div id="imagePreviews" class="mt-2 flex flex-wrap gap-2"></div>
          </div>

          <div class="mb-3">
            <label for="memo" class="form-label">บันทึกช่วยจำ</label>
            <textarea class="form-control" id="memo" rows="3"></textarea>
          </div>

          <button type="submit" class="btn btn-primary me-2">บันทึกธุรกรรม</button>
          <button type="button" class="btn btn-secondary" id="cancelTransactionEdit">ยกเลิก</button>
        </form>
      </div>

      <div class="card p-4 mb-4">
        <h5 class="font-semibold text-lg mb-3">ค้นหารายการธุรกรรม</h5>
        <form id="transactionSearchForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          <div class="mb-3">
            <label for="searchKeyword" class="form-label">คำค้นหา</label>
            <input type="text" class="form-control" id="searchKeyword" placeholder="ชื่อรายการ, บันทึกช่วยจำ">
          </div>
          <div class="mb-3">
            <label for="searchStartDate" class="form-label">จากวันที่</label>
            <input type="date" class="form-control" id="searchStartDate">
          </div>
          <div class="mb-3">
            <label for="searchEndDate" class="form-label">ถึงวันที่</label>
            <input type="date" class="form-control" id="searchEndDate">
          </div>
          <div class="mb-3">
            <label class="form-label">หมวดหมู่</label>
            <div id="searchCategoriesCheckboxes" class="form-check-group"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">กระเป๋า</label>
            <div id="searchWalletsCheckboxes" class="form-check-group"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">แท็ก</label>
            <div id="searchTagsCheckboxes" class="form-check-group"></div>
          </div>
          <div class="col-span-1 md:col-span-3 text-end">
            <button type="submit" class="btn btn-info me-2"><i class="bi bi-search"></i> ค้นหา</button>
            <button type="button" class="btn btn-secondary" id="resetSearchBtn"><i class="bi bi-arrow-counterclockwise"></i> ล้างค่า</button>
          </div>
        </form>
      </div>

      <div class="card p-4">
        <h5 class="font-semibold text-lg mb-3">รายการธุรกรรมทั้งหมด</h5>
        <div id="transactionList" class="table-responsive">
          <!-- Transactions will be loaded here -->
          <p class="text-center text-gray-500">ไม่มีรายการธุรกรรม</p>
        </div>
      </div>
    </div>

    <!-- Wallets Tab -->
    <div class="tab-pane fade" id="wallets" role="tabpanel" aria-labelledby="wallets-tab">
      <div class="card p-4 mb-4">
        <h5 class="font-semibold text-lg mb-3">จัดการกระเป๋า</h5>
        <form id="walletForm">
          <input type="hidden" id="walletId" value="">
          <div class="mb-3">
            <label for="walletName" class="form-label">ชื่อกระเป๋า <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="walletName" required>
          </div>
          <div class="mb-3">
            <label for="walletInitialAmount" class="form-label">จำนวนเงินเริ่มต้น <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="walletInitialAmount" required>
          </div>
          <div class="mb-3">
            <label for="walletCurrency" class="form-label">สกุลเงินหลัก (3 ตัวอักษร ISO 4217) <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="walletCurrency" maxlength="3" pattern="[A-Z]{3}" title="กรุณากรอกรหัสสกุลเงิน 3 ตัวอักษร (ISO 4217)" required>
          </div>
          <div class="mb-3">
            <label for="walletMemo" class="form-label">บันทึกช่วยจำ</label>
            <textarea class="form-control" id="walletMemo" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="walletColor" class="form-label">สี <span class="text-danger">*</span></label>
            <input type="color" class="form-control form-control-color" id="walletColor" value="#6c757d" title="เลือกสี">
          </div>
          <div class="mb-3">
            <label for="walletIcon" class="form-label">ไอคอน (Bootstrap Icon Class Name) <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="walletIcon" value="bi-wallet" required>
            <small class="form-text text-muted">ตัวอย่าง: bi-wallet, bi-cash-stack. ดูได้ที่ <a href="https://icons.getbootstrap.com/" target="_blank">Bootstrap Icons</a></small>
            <i id="walletIconPreview" class="icon-preview bi-wallet"></i>
          </div>
          <button type="submit" class="btn btn-primary me-2">บันทึกกระเป๋า</button>
          <button type="button" class="btn btn-secondary" id="cancelWalletEdit">ยกเลิก</button>
        </form>
      </div>

      <div class="card p-4">
        <h5 class="font-semibold text-lg mb-3">รายการกระเป๋า</h5>
        <div id="walletList" class="table-responsive">
          <p class="text-center text-gray-500">ไม่มีรายการกระเป๋า</p>
        </div>
      </div>
    </div>

    <!-- Categories Tab -->
    <div class="tab-pane fade" id="categories" role="tabpanel" aria-labelledby="categories-tab">
      <div class="card p-4 mb-4">
        <h5 class="font-semibold text-lg mb-3">จัดการหมวดหมู่</h5>
        <form id="categoryForm">
          <input type="hidden" id="categoryId" value="">
          <div class="mb-3">
            <label class="form-label">ประเภท <span class="text-danger">*</span></label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="categoryType" id="categoryTypeIncome" value="Income" checked>
                <label class="form-check-label" for="categoryTypeIncome">รายรับ</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="categoryType" id="categoryTypeExpense" value="Expense">
                <label class="form-check-label" for="categoryTypeExpense">รายจ่าย</label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="categoryName" class="form-label">ชื่อหมวดหมู่ <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="categoryName" required>
          </div>
          <div class="mb-3">
            <label for="categoryColor" class="form-label">สี <span class="text-danger">*</span></label>
            <input type="color" class="form-control form-control-color" id="categoryColor" value="#007bff" title="เลือกสี">
          </div>
          <div class="mb-3">
            <label for="categoryIcon" class="form-label">ไอคอน (Bootstrap Icon Class Name) <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="categoryIcon" value="bi-tag" required>
            <small class="form-text text-muted">ตัวอย่าง: bi-tag, bi-wallet. ดูได้ที่ <a href="https://icons.getbootstrap.com/" target="_blank">Bootstrap Icons</a></small>
            <i id="categoryIconPreview" class="icon-preview bi-tag"></i>
          </div>
          <button type="submit" class="btn btn-primary me-2">บันทึกหมวดหมู่</button>
          <button type="button" class="btn btn-secondary" id="cancelCategoryEdit">ยกเลิก</button>
        </form>
      </div>

      <div class="card p-4">
        <h5 class="font-semibold text-lg mb-3">รายการหมวดหมู่</h5>
        <div id="categoryList" class="table-responsive">
          <p class="text-center text-gray-500">ไม่มีรายการหมวดหมู่</p>
        </div>
      </div>
    </div>

    <!-- Tags Tab -->
    <div class="tab-pane fade" id="tags" role="tabpanel" aria-labelledby="tags-tab">
      <div class="card p-4 mb-4">
        <h5 class="font-semibold text-lg mb-3">จัดการแท็ก</h5>
        <form id="tagForm">
          <input type="hidden" id="tagId" value="">
          <div class="mb-3">
            <label for="tagName" class="form-label">ชื่อแท็ก <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="tagName" required>
          </div>
          <div class="mb-3">
            <label for="tagColor" class="form-label">สี <span class="text-danger">*</span></label>
            <input type="color" class="form-control form-control-color" id="tagColor" value="#6c757d" title="เลือกสี">
          </div>
          <button type="submit" class="btn btn-primary me-2">บันทึกแท็ก</button>
          <button type="button" class="btn btn-secondary" id="cancelTagEdit">ยกเลิก</button>
        </form>
      </div>

      <div class="card p-4">
        <h5 class="font-semibold text-lg mb-3">รายการแท็ก</h5>
        <div id="tagList" class="table-responsive">
          <p class="text-center text-gray-500">ไม่มีรายการแท็ก</p>
        </div>
      </div>
    </div>

    <!-- Currencies Tab -->
    <div class="tab-pane fade" id="currencies" role="tabpanel" aria-labelledby="currencies-tab">
      <div class="card p-4 mb-4">
        <h5 class="font-semibold text-lg mb-3">จัดการอัตราแลกเปลี่ยนสกุลเงิน</h5>
        <form id="currencyForm">
          <input type="hidden" id="currencyId" value="">
          <div class="mb-3">
            <label for="fromCurrency" class="form-label">จากสกุลเงิน (3 ตัวอักษร ISO 4217) <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="fromCurrency" maxlength="3" pattern="[A-Z]{3}" title="กรุณากรอกรหัสสกุลเงิน 3 ตัวอักษร (ISO 4217)" required>
          </div>
          <div class="mb-3">
            <label for="toCurrency" class="form-label">เป็นสกุลเงิน (3 ตัวอักษร ISO 4217) <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="toCurrency" maxlength="3" pattern="[A-Z]{3}" title="กรุณากรอกรหัสสกุลเงิน 3 ตัวอักษร (ISO 4217)" required>
          </div>
          <div class="mb-3">
            <label for="exchangeRate" class="form-label">อัตราแลกเปลี่ยน (เช่น 1.125 สำหรับ 1 TWD = 1.125 THB) <span class="text-danger">*</span></label>
            <input type="number" step="0.0001" class="form-control" id="exchangeRate" min="0" required>
          </div>
          <button type="submit" class="btn btn-primary me-2">บันทึกอัตราแลกเปลี่ยน</button>
          <button type="button" class="btn btn-secondary" id="cancelCurrencyEdit">ยกเลิก</button>
        </form>
      </div>

      <div class="card p-4">
        <h5 class="font-semibold text-lg mb-3">รายการอัตราแลกเปลี่ยน</h5>
        <div id="currencyList" class="table-responsive">
          <p class="text-center text-gray-500">ไม่มีรายการอัตราแลกเปลี่ยน</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Universal Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">ยืนยันการดำเนินการ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmationModalBody">
        คุณแน่ใจหรือไม่ที่ต้องการดำเนินการนี้?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        <button type="button" class="btn btn-danger" id="confirmActionBtn">ยืนยัน</button>
      </div>
    </div>
  </div>
</div>

<!-- Universal Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="messageModalLabel">ข้อความ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="messageModalBody">
        นี่คือข้อความ
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ตกลง</button>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1" aria-labelledby="transactionDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transactionDetailsModalLabel">รายละเอียดธุรกรรม</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="transactionDetailsContent">
          <!-- Details will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
      </div>
    </div>
  </div>
</div>

<!-- Daily Transactions Modal (for Calendar click) -->
<div class="modal fade" id="dailyTransactionsModal" tabindex="-1" aria-labelledby="dailyTransactionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dailyTransactionsModalLabel">รายการธุรกรรมประจำวันที่ <span id="dailyTransactionsDate"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="dailyTransactionsList">
          <!-- Daily transactions will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
      </div>
    </div>
  </div>
</div>


<script>
  // *** สำคัญ: โปรดเปลี่ยนค่านี้ให้เป็น URL ของ Google App Script Web App ที่คุณ Deploy ไว้ ***
  // คุณสามารถหา URL นี้ได้จากการ Deploy App Script (Deploy > New deployment > Web app)
  const APP_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwrWU3rmiiA2fFGIhenZAl056w4kNJWua2KwRQDbUwCjpHoiXqSQgJp9sIChifSQEm6Ow/exec';

  // Helper function to show loading overlay
  function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }

  // Helper function to hide loading overlay
  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  // Universal Message Modal
  const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
  function showMessage(title, message) {
    document.getElementById('messageModalLabel').innerText = title;
    document.getElementById('messageModalBody').innerText = message;
    messageModal.show();
  }

  // Universal Confirmation Modal
  const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
  let confirmCallback = null;
  function showConfirmation(message, callback) {
    document.getElementById('confirmationModalBody').innerText = message;
    confirmCallback = callback;
    confirmationModal.show();
  }
  document.getElementById('confirmActionBtn').addEventListener('click', () => {
    if (confirmCallback) {
      confirmCallback();
    }
    confirmationModal.hide();
  });

  // --- Global Data Storage ---
  let allWallets = [];
  let allCategories = [];
  let allTags = [];
  let allCurrencies = [];
  let allTransactions = [];
  let currentCalendarDate = new Date(); // For Overview calendar

  // --- API Call Helper ---
  async function callAppScript(functionName, args = []) {
    try {
      const response = await fetch(APP_SCRIPT_WEB_APP_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          function: functionName,
          args: args
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
      }

      const result = await response.json();

      if (result.success) {
        return result.data;
      } else {
        throw new Error(result.error || 'Unknown error from App Script.');
      }
    } catch (error) {
      console.error('Error calling App Script function:', functionName, error);
      throw error; // Re-throw to be caught by the specific handler
    }
  }

  // --- Utility Functions ---
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('th-TH', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      timeZone: 'Asia/Bangkok'
    });
  }

  function formatCurrency(amount, currency) {
    return new Intl.NumberFormat('th-TH', { style: 'currency', currency: currency || 'THB' }).format(amount);
  }

  // --- Data Loading Functions ---

  async function loadAllData() {
    showLoading();
    try {
      [allWallets, allCategories, allTags, allCurrencies, allTransactions] = await Promise.all([
        callAppScript('getWallets'),
        callAppScript('getCategories'),
        callAppScript('getTags'),
        callAppScript('getCurrencies'),
        callAppScript('getTransactions')
      ]);
      console.log('All data loaded:', { allWallets, allCategories, allTags, allCurrencies, allTransactions });
      renderWallets();
      renderCategories();
      renderTags();
      renderCurrencies();
      renderTransactions();
      populateTransactionFormDropdowns();
      populateSearchFilters();
      loadOverviewData(); // Default to current month/year
      loadRecentItemNames(); // For autocomplete
    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  }

  function handleError(error) {
    console.error('App Script Error:', error);
    showMessage('เกิดข้อผิดพลาด', error.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
    hideLoading();
  }

  // --- Wallet Management ---
  const walletForm = document.getElementById('walletForm');
  const walletIdInput = document.getElementById('walletId');
  const walletNameInput = document.getElementById('walletName');
  const walletInitialAmountInput = document.getElementById('walletInitialAmount');
  const walletCurrencyInput = document.getElementById('walletCurrency');
  const walletMemoInput = document.getElementById('walletMemo');
  const walletColorInput = document.getElementById('walletColor');
  const walletIconInput = document.getElementById('walletIcon');
  const walletIconPreview = document.getElementById('walletIconPreview');
  const walletListDiv = document.getElementById('walletList');
  const cancelWalletEditBtn = document.getElementById('cancelWalletEdit');

  walletIconInput.addEventListener('input', () => {
    walletIconPreview.className = `icon-preview ${walletIconInput.value}`;
  });

  walletForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const walletData = {
      Name: walletNameInput.value,
      InitialAmount: parseFloat(walletInitialAmountInput.value),
      Currency: walletCurrencyInput.value.toUpperCase(),
      Memo: walletMemoInput.value,
      Color: walletColorInput.value,
      Icon: walletIconInput.value
    };

    try {
      if (walletIdInput.value) {
        await callAppScript('updateWallet', [walletIdInput.value, walletData]);
        showMessage('สำเร็จ', 'อัปเดตกระเป๋าเรียบร้อยแล้ว');
      } else {
        await callAppScript('addWallet', [walletData]);
        showMessage('สำเร็จ', 'เพิ่มกระเป๋าเรียบร้อยแล้ว');
      }
      resetWalletForm();
      loadAllData();
    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  });

  function resetWalletForm() {
    walletIdInput.value = '';
    walletNameInput.value = '';
    walletInitialAmountInput.value = '';
    walletCurrencyInput.value = '';
    walletMemoInput.value = '';
    walletColorInput.value = '#6c757d';
    walletIconInput.value = 'bi-wallet';
    walletIconPreview.className = 'icon-preview bi-wallet';
    walletForm.querySelector('button[type="submit"]').innerText = 'บันทึกกระเป๋า';
    cancelWalletEditBtn.classList.add('hidden');
  }

  cancelWalletEditBtn.addEventListener('click', resetWalletForm);

  function renderWallets() {
    if (allWallets.length === 0) {
      walletListDiv.innerHTML = '<p class="text-center text-gray-500">ไม่มีรายการกระเป๋า</p>';
      return;
    }

    let html = `
      <table class="table table-hover table-striped">
        <thead>
          <tr>
            <th>ชื่อ</th>
            <th>ยอดเริ่มต้น</th>
            <th>ยอดคงเหลือ</th>
            <th>สกุลเงิน</th>
            <th>สี</th>
            <th>ไอคอน</th>
            <th>จัดการ</th>
          </tr>
        </thead>
        <tbody>
    `;
    allWallets.forEach(wallet => {
      html += `
        <tr>
          <td>${wallet.Name}</td>
          <td>${formatCurrency(wallet.InitialAmount, wallet.Currency)}</td>
          <td>${formatCurrency(wallet.CurrentBalance, wallet.Currency)}</td>
          <td>${wallet.Currency}</td>
          <td><div class="color-box" style="background-color: ${wallet.Color};"></div></td>
          <td><i class="${wallet.Icon}"></i></td>
          <td>
            <button class="btn btn-sm btn-warning me-2" onclick="editWallet('${wallet.ID}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeleteWallet('${wallet.ID}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    walletListDiv.innerHTML = html;
  }

  function editWallet(id) {
    const wallet = allWallets.find(w => w.ID === id);
    if (wallet) {
      walletIdInput.value = wallet.ID;
      walletNameInput.value = wallet.Name;
      walletInitialAmountInput.value = wallet.InitialAmount;
      walletCurrencyInput.value = wallet.Currency;
      walletMemoInput.value = wallet.Memo;
      walletColorInput.value = wallet.Color;
      walletIconInput.value = wallet.Icon;
      walletIconPreview.className = `icon-preview ${wallet.Icon}`;
      walletForm.querySelector('button[type="submit"]').innerText = 'อัปเดตกระเป๋า';
      cancelWalletEditBtn.classList.remove('hidden');
      document.getElementById('wallets-tab').click(); // Switch to wallets tab
    }
  }

  function confirmDeleteWallet(id) {
    showConfirmation('คุณแน่ใจหรือไม่ที่ต้องการลบกระเป๋านี้? (หากมีธุรกรรมที่เกี่ยวข้องจะไม่สามารถลบได้)', async () => {
      showLoading();
      try {
        await callAppScript('deleteWallet', [id]);
        showMessage('สำเร็จ', 'ลบกระเป๋าเรียบร้อยแล้ว');
        loadAllData();
      } catch (error) {
        handleError(error);
      } finally {
        hideLoading();
      }
    });
  }

  // --- Category Management ---
  const categoryForm = document.getElementById('categoryForm');
  const categoryIdInput = document.getElementById('categoryId');
  const categoryTypeIncomeRadio = document.getElementById('categoryTypeIncome');
  const categoryTypeExpenseRadio = document.getElementById('categoryTypeExpense');
  const categoryNameInput = document.getElementById('categoryName');
  const categoryColorInput = document.getElementById('categoryColor');
  const categoryIconInput = document.getElementById('categoryIcon');
  const categoryIconPreview = document.getElementById('categoryIconPreview');
  const categoryListDiv = document.getElementById('categoryList');
  const cancelCategoryEditBtn = document.getElementById('cancelCategoryEdit');

  categoryIconInput.addEventListener('input', () => {
    categoryIconPreview.className = `icon-preview ${categoryIconInput.value}`;
  });

  categoryForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const categoryData = {
      Type: categoryTypeIncomeRadio.checked ? 'Income' : 'Expense',
      Name: categoryNameInput.value,
      Color: categoryColorInput.value,
      Icon: categoryIconInput.value
    };

    try {
      if (categoryIdInput.value) {
        await callAppScript('updateCategory', [categoryIdInput.value, categoryData]);
        showMessage('สำเร็จ', 'อัปเดตหมวดหมู่เรียบร้อยแล้ว');
      } else {
        await callAppScript('addCategory', [categoryData]);
        showMessage('สำเร็จ', 'เพิ่มหมวดหมู่เรียบร้อยแล้ว');
      }
      resetCategoryForm();
      loadAllData();
    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  });

  function resetCategoryForm() {
    categoryIdInput.value = '';
    categoryTypeIncomeRadio.checked = true;
    categoryNameInput.value = '';
    categoryColorInput.value = '#007bff';
    categoryIconInput.value = 'bi-tag';
    categoryIconPreview.className = 'icon-preview bi-tag';
    categoryForm.querySelector('button[type="submit"]').innerText = 'บันทึกหมวดหมู่';
    cancelCategoryEditBtn.classList.add('hidden');
  }

  cancelCategoryEditBtn.addEventListener('click', resetCategoryForm);

  function renderCategories() {
    if (allCategories.length === 0) {
      categoryListDiv.innerHTML = '<p class="text-center text-gray-500">ไม่มีรายการหมวดหมู่</p>';
      return;
    }

    let html = `
      <table class="table table-hover table-striped">
        <thead>
          <tr>
            <th>ประเภท</th>
            <th>ชื่อ</th>
            <th>สี</th>
            <th>ไอคอน</th>
            <th>จัดการ</th>
          </tr>
        </thead>
        <tbody>
    `;
    allCategories.forEach(category => {
      html += `
        <tr>
          <td>${category.Type === 'Income' ? 'รายรับ' : 'รายจ่าย'}</td>
          <td>${category.Name}</td>
          <td><div class="color-box" style="background-color: ${category.Color};"></div></td>
          <td><i class="${category.Icon}"></i></td>
          <td>
            <button class="btn btn-sm btn-warning me-2" onclick="editCategory('${category.ID}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeleteCategory('${category.ID}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    categoryListDiv.innerHTML = html;
  }

  function editCategory(id) {
    const category = allCategories.find(c => c.ID === id);
    if (category) {
      categoryIdInput.value = category.ID;
      if (category.Type === 'Income') categoryTypeIncomeRadio.checked = true;
      else categoryTypeExpenseRadio.checked = true;
      categoryNameInput.value = category.Name;
      categoryColorInput.value = category.Color;
      categoryIconInput.value = category.Icon;
      categoryIconPreview.className = `icon-preview ${category.Icon}`;
      categoryForm.querySelector('button[type="submit"]').innerText = 'อัปเดตหมวดหมู่';
      cancelCategoryEditBtn.classList.remove('hidden');
      document.getElementById('categories-tab').click(); // Switch to categories tab
    }
  }

  function confirmDeleteCategory(id) {
    showConfirmation('คุณแน่ใจหรือไม่ที่ต้องการลบหมวดหมู่นี้? (หากมีธุรกรรมที่เกี่ยวข้องจะไม่สามารถลบได้)', async () => {
      showLoading();
      try {
        await callAppScript('deleteCategory', [id]);
        showMessage('สำเร็จ', 'ลบหมวดหมู่เรียบร้อยแล้ว');
        loadAllData();
      } catch (error) {
        handleError(error);
      } finally {
        hideLoading();
      }
    });
  }

  // --- Tag Management ---
  const tagForm = document.getElementById('tagForm');
  const tagIdInput = document.getElementById('tagId');
  const tagNameInput = document.getElementById('tagName');
  const tagColorInput = document.getElementById('tagColor');
  const tagListDiv = document.getElementById('tagList');
  const cancelTagEditBtn = document.getElementById('cancelTagEdit');

  tagForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const tagData = {
      Name: tagNameInput.value,
      Color: tagColorInput.value
    };

    try {
      if (tagIdInput.value) {
        await callAppScript('updateTag', [tagIdInput.value, tagData]);
        showMessage('สำเร็จ', 'อัปเดตแท็กเรียบร้อยแล้ว');
      } else {
        await callAppScript('addTag', [tagData]);
        showMessage('สำเร็จ', 'เพิ่มแท็กเรียบร้อยแล้ว');
      }
      resetTagForm();
      loadAllData();
    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  });

  function resetTagForm() {
    tagIdInput.value = '';
    tagNameInput.value = '';
    tagColorInput.value = '#6c757d';
    tagForm.querySelector('button[type="submit"]').innerText = 'บันทึกแท็ก';
    cancelTagEditBtn.classList.add('hidden');
  }

  cancelTagEditBtn.addEventListener('click', resetTagForm);

  function renderTags() {
    if (allTags.length === 0) {
      tagListDiv.innerHTML = '<p class="text-center text-gray-500">ไม่มีรายการแท็ก</p>';
      return;
    }

    let html = `
      <table class="table table-hover table-striped">
        <thead>
          <tr>
            <th>ชื่อแท็ก</th>
            <th>สี</th>
            <th>จัดการ</th>
          </tr>
        </thead>
        <tbody>
    `;
    allTags.forEach(tag => {
      html += `
        <tr>
          <td>${tag.Name}</td>
          <td><div class="color-box" style="background-color: ${tag.Color};"></div></td>
          <td>
            <button class="btn btn-sm btn-warning me-2" onclick="editTag('${tag.ID}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeleteTag('${tag.ID}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    tagListDiv.innerHTML = html;
  }

  function editTag(id) {
    const tag = allTags.find(t => t.ID === id);
    if (tag) {
      tagIdInput.value = tag.ID;
      tagNameInput.value = tag.Name;
      tagColorInput.value = tag.Color;
      tagForm.querySelector('button[type="submit"]').innerText = 'อัปเดตแท็ก';
      cancelTagEditBtn.classList.remove('hidden');
      document.getElementById('tags-tab').click(); // Switch to tags tab
    }
  }

  function confirmDeleteTag(id) {
    showConfirmation('คุณแน่ใจหรือไม่ที่ต้องการลบแท็กนี้? (หากมีธุรกรรมที่เกี่ยวข้องจะไม่สามารถลบได้)', async () => {
      showLoading();
      try {
        await callAppScript('deleteTag', [id]);
        showMessage('สำเร็จ', 'ลบแท็กเรียบร้อยแล้ว');
        loadAllData();
      } catch (error) {
        handleError(error);
      } finally {
        hideLoading();
      }
    });
  }

  // --- Currency Management ---
  const currencyForm = document.getElementById('currencyForm');
  const currencyIdInput = document.getElementById('currencyId');
  const fromCurrencyInput = document.getElementById('fromCurrency');
  const toCurrencyInput = document.getElementById('toCurrency');
  const exchangeRateInput = document.getElementById('exchangeRate');
  const currencyListDiv = document.getElementById('currencyList');
  const cancelCurrencyEditBtn = document.getElementById('cancelCurrencyEdit');

  currencyForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const currencyData = {
      FromCurrency: fromCurrencyInput.value.toUpperCase(),
      ToCurrency: toCurrencyInput.value.toUpperCase(),
      Rate: parseFloat(exchangeRateInput.value)
    };

    try {
      if (currencyIdInput.value) {
        await callAppScript('updateCurrency', [currencyIdInput.value, currencyData]);
        showMessage('สำเร็จ', 'อัปเดตอัตราแลกเปลี่ยนเรียบร้อยแล้ว');
      } else {
        await callAppScript('addCurrency', [currencyData]);
        showMessage('สำเร็จ', 'เพิ่มอัตราแลกเปลี่ยนเรียบร้อยแล้ว');
      }
      resetCurrencyForm();
      loadAllData();
    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  });

  function resetCurrencyForm() {
    currencyIdInput.value = '';
    fromCurrencyInput.value = '';
    toCurrencyInput.value = '';
    exchangeRateInput.value = '';
    currencyForm.querySelector('button[type="submit"]').innerText = 'บันทึกอัตราแลกเปลี่ยน';
    cancelCurrencyEditBtn.classList.add('hidden');
  }

  cancelCurrencyEditBtn.addEventListener('click', resetCurrencyForm);

  function renderCurrencies() {
    if (allCurrencies.length === 0) {
      currencyListDiv.innerHTML = '<p class="text-center text-gray-500">ไม่มีรายการอัตราแลกเปลี่ยน</p>';
      return;
    }

    let html = `
      <table class="table table-hover table-striped">
        <thead>
          <tr>
            <th>จากสกุลเงิน</th>
            <th>เป็นสกุลเงิน</th>
            <th>อัตราแลกเปลี่ยน</th>
            <th>จัดการ</th>
          </tr>
        </thead>
        <tbody>
    `;
    allCurrencies.forEach(currency => {
      html += `
        <tr>
          <td>${currency.FromCurrency}</td>
          <td>${currency.ToCurrency}</td>
          <td>${currency.Rate.toFixed(4)}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2" onclick="editCurrency('${currency.ID}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeleteCurrency('${currency.ID}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    currencyListDiv.innerHTML = html;
  }

  function editCurrency(id) {
    const currency = allCurrencies.find(c => c.ID === id);
    if (currency) {
      currencyIdInput.value = currency.ID;
      fromCurrencyInput.value = currency.FromCurrency;
      toCurrencyInput.value = currency.ToCurrency;
      exchangeRateInput.value = currency.Rate;
      currencyForm.querySelector('button[type="submit"]').innerText = 'อัปเดตอัตราแลกเปลี่ยน';
      cancelCurrencyEditBtn.classList.remove('hidden');
      document.getElementById('currencies-tab').click(); // Switch to currencies tab
    }
  }

  function confirmDeleteCurrency(id) {
    showConfirmation('คุณแน่ใจหรือไม่ที่ต้องการลบอัตราแลกเปลี่ยนนี้?', async () => {
      showLoading();
      try {
        await callAppScript('deleteCurrency', [id]);
        showMessage('สำเร็จ', 'ลบอัตราแลกเปลี่ยนเรียบร้อยแล้ว');
        loadAllData();
      } catch (error) {
        handleError(error);
      } finally {
        hideLoading();
      }
    });
  }

  // --- Transaction Management ---
  const transactionForm = document.getElementById('transactionForm');
  const transactionIdInput = document.getElementById('transactionId');
  const transactionTypeRadios = document.querySelectorAll('input[name="transactionType"]');
  const sourceWalletSelect = document.getElementById('sourceWallet');
  const destinationWalletGroup = document.getElementById('destinationWalletGroup');
  const destinationWalletSelect = document.getElementById('destinationWallet');
  const categoryGroup = document.getElementById('categoryGroup');
  const categorySelect = document.getElementById('category');
  const amountInput = document.getElementById('amount');
  const itemNameInput = document.getElementById('itemName');
  const recentItemNamesDatalist = document.getElementById('recentItemNames');
  const transactionDateTimeInput = document.getElementById('transactionDateTime');
  const tagsSelect = document.getElementById('tags');
  const newTagInput = document.getElementById('newTagInput');
  const imageUploadInput = document.getElementById('imageUpload');
  const imagePreviewsDiv = document.getElementById('imagePreviews');
  const memoInput = document.getElementById('memo');
  const transactionListDiv = document.getElementById('transactionList');
  const cancelTransactionEditBtn = document.getElementById('cancelTransactionEdit');

  let uploadedImageFiles = []; // Store File objects for new uploads
  let existingImagePaths = []; // Store existing Drive IDs for editing

  // Event listeners for transaction type change
  transactionTypeRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      const type = radio.value;
      if (type === 'Transfer') {
        destinationWalletGroup.classList.remove('hidden');
        categoryGroup.classList.add('hidden');
        categorySelect.removeAttribute('required');
        destinationWalletSelect.setAttribute('required', 'required');
      } else {
        destinationWalletGroup.classList.add('hidden');
        categoryGroup.classList.remove('hidden');
        categorySelect.setAttribute('required', 'required');
        destinationWalletSelect.removeAttribute('required');
      }
      populateCategoryDropdown(type);
    });
  });

  // Event listener for source wallet change (for transfer)
  sourceWalletSelect.addEventListener('change', () => {
    const selectedSourceWalletId = sourceWalletSelect.value;
    const destOptions = destinationWalletSelect.querySelectorAll('option');
    destOptions.forEach(option => {
      if (option.value === selectedSourceWalletId) {
        option.disabled = true;
      } else {
        option.disabled = false;
      }
    });
    // If destination is same as source, reset destination
    if (destinationWalletSelect.value === selectedSourceWalletId) {
      destinationWalletSelect.value = '';
    }
  });

  // Event listener for new tag input
  newTagInput.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter' && newTagInput.value.trim() !== '') {
      e.preventDefault();
      const newTagName = newTagInput.value.trim();
      const existingTag = allTags.find(t => t.Name.toLowerCase() === newTagName.toLowerCase());
      if (existingTag) {
        showMessage('แจ้งเตือน', `แท็ก "${newTagName}" มีอยู่แล้ว`);
        newTagInput.value = '';
        return;
      }

      showLoading();
      try {
        const newTag = await callAppScript('addTag', [{ Name: newTagName, Color: '#6c757d' }]); // Default color
        allTags.push(newTag); // Update local cache
        populateTagsDropdown(); // Re-populate dropdown
        // Select the newly added tag
        const options = Array.from(tagsSelect.options);
        const newOption = options.find(opt => opt.value === newTag.ID);
        if (newOption) {
          newOption.selected = true;
        }
        newTagInput.value = '';
        showMessage('สำเร็จ', `เพิ่มแท็ก "${newTagName}" เรียบร้อยแล้ว`);
      } catch (error) {
        handleError(error);
      } finally {
        hideLoading();
      }
    }
  });

  // Event listener for image upload
  imageUploadInput.addEventListener('change', (e) => {
    uploadedImageFiles = Array.from(e.target.files).slice(0, 3); // Limit to 3 files
    renderImagePreviews();
  });

  function renderImagePreviews() {
    imagePreviewsDiv.innerHTML = '';
    const filesToPreview = [...uploadedImageFiles]; // Files from current upload input
    const existingImages = existingImagePaths.map(id => `https://drive.google.com/thumbnail?id=${id}`); // Existing images from Drive

    // Add existing images to preview
    existingImages.forEach((src, index) => {
      const imgContainer = document.createElement('div');
      imgContainer.className = 'relative w-24 h-24 rounded-lg overflow-hidden border border-gray-300';
      imgContainer.innerHTML = `
        <img src="${src}" class="w-full h-full object-cover" alt="Image Preview">
        <button type="button" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs" onclick="removeExistingImage('${existingImagePaths[index]}')">
          <i class="bi bi-x"></i>
        </button>
      `;
      imagePreviewsDiv.appendChild(imgContainer);
    });

    // Add newly selected files to preview
    filesToPreview.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const imgContainer = document.createElement('div');
        imgContainer.className = 'relative w-24 h-24 rounded-lg overflow-hidden border border-gray-300';
        imgContainer.innerHTML = `
          <img src="${e.target.result}" class="w-full h-full object-cover" alt="Image Preview">
          <button type="button" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs" onclick="removeNewImage(${index})">
            <i class="bi bi-x"></i>
          </button>
        `;
        imagePreviewsDiv.appendChild(imgContainer);
      };
      reader.readAsDataURL(file);
    });
  }

  function removeNewImage(index) {
    uploadedImageFiles.splice(index, 1);
    imageUploadInput.value = ''; // Clear file input to re-trigger change if same file is selected
    renderImagePreviews();
  }

  function removeExistingImage(imageId) {
    existingImagePaths = existingImagePaths.filter(id => id !== imageId);
    renderImagePreviews();
  }


  transactionForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();

    const selectedTags = Array.from(tagsSelect.selectedOptions).map(option => option.value);
    const transactionType = document.querySelector('input[name="transactionType"]:checked').value;

    let transactionData = {
      Type: transactionType,
      Timestamp: transactionDateTimeInput.value,
      Amount: parseFloat(amountInput.value),
      SourceWalletID: sourceWalletSelect.value,
      DestinationWalletID: transactionType === 'Transfer' ? destinationWalletSelect.value : '',
      CategoryID: transactionType !== 'Transfer' ? categorySelect.value : '',
      ItemName: itemNameInput.value,
      Tags: selectedTags,
      ImagePaths: existingImagePaths, // Start with existing paths
      Memo: memoInput.value
    };

    // Upload new images
    const newImageIds = [];
    for (const file of uploadedImageFiles) {
      try {
        const base64Data = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = error => reject(error);
          reader.readAsDataURL(file);
        });
        const fileId = await callAppScript('uploadImageToDrive', [base64Data, file.name]);
        newImageIds.push(fileId);
      } catch (error) {
        handleError(error);
        hideLoading();
        return; // Stop submission if upload fails
      }
    }
    transactionData.ImagePaths = [...existingImagePaths, ...newImageIds]; // Combine existing and new

    try {
      if (transactionIdInput.value) {
        await callAppScript('updateTransaction', [transactionIdInput.value, transactionData]);
        showMessage('สำเร็จ', 'อัปเดตธุรกรรมเรียบร้อยแล้ว');
      } else {
        await callAppScript('addTransaction', [transactionData]);
        showMessage('สำเร็จ', 'เพิ่มธุรกรรมเรียบร้อยแล้ว');
      }
      resetTransactionForm();
      loadAllData();
    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  });

  function resetTransactionForm() {
    transactionIdInput.value = '';
    document.getElementById('typeIncome').checked = true;
    destinationWalletGroup.classList.add('hidden');
    categoryGroup.classList.remove('hidden');
    sourceWalletSelect.value = '';
    destinationWalletSelect.value = '';
    categorySelect.value = '';
    amountInput.value = '';
    itemNameInput.value = '';
    transactionDateTimeInput.value = ''; // Will be set by populateTransactionFormDropdowns
    tagsSelect.value = '';
    Array.from(tagsSelect.options).forEach(option => option.selected = false);
    newTagInput.value = '';
    imageUploadInput.value = '';
    uploadedImageFiles = [];
    existingImagePaths = [];
    imagePreviewsDiv.innerHTML = '';
    memoInput.value = '';
    transactionForm.querySelector('button[type="submit"]').innerText = 'บันทึกธุรกรรม';
    cancelTransactionEditBtn.classList.add('hidden');
    populateTransactionFormDropdowns(); // Re-populate with defaults
  }

  cancelTransactionEditBtn.addEventListener('click', resetTransactionForm);

  function populateTransactionFormDropdowns() {
    // Wallets
    sourceWalletSelect.innerHTML = '<option value="">เลือกกระเป๋า</option>';
    destinationWalletSelect.innerHTML = '<option value="">เลือกกระเป๋า</option>';
    allWallets.forEach(wallet => {
      const option = `<option value="${wallet.ID}">${wallet.Name} (${wallet.Currency})</option>`;
      sourceWalletSelect.innerHTML += option;
      destinationWalletSelect.innerHTML += option;
    });

    // Categories (default to Income)
    populateCategoryDropdown('Income');

    // Tags
    populateTagsDropdown();

    // Set default datetime to current local time, then convert to UTC+7 for display
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000; // Offset in milliseconds
    const localDateTime = new Date(now.getTime() - offset);
    transactionDateTimeInput.value = localDateTime.toISOString().slice(0, 16);
  }

  function populateCategoryDropdown(type) {
    categorySelect.innerHTML = '<option value="">เลือกหมวดหมู่</option>';
    allCategories.filter(cat => cat.Type === type).forEach(category => {
      categorySelect.innerHTML += `<option value="${category.ID}">${category.Name}</option>`;
    });
  }

  function populateTagsDropdown() {
    tagsSelect.innerHTML = '';
    allTags.forEach(tag => {
      tagsSelect.innerHTML += `<option value="${tag.ID}">${tag.Name}</option>`;
    });
  }

  async function loadRecentItemNames() {
    showLoading();
    try {
      const recentNames = await callAppScript('getRecentItemNames');
      recentItemNamesDatalist.innerHTML = '';
      recentNames.forEach(name => {
        recentItemNamesDatalist.innerHTML += `<option value="${name}">`;
      });
    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  }

  function renderTransactions(transactionsToRender = allTransactions) {
    if (transactionsToRender.length === 0) {
      transactionListDiv.innerHTML = '<p class="text-center text-gray-500">ไม่มีรายการธุรกรรม</p>';
      return;
    }

    let html = '';
    let currentGroupDate = '';

    transactionsToRender.forEach(tx => {
      const txDate = new Date(tx.Timestamp);
      const dateOnly = txDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Bangkok' });

      if (dateOnly !== currentGroupDate) {
        if (currentGroupDate !== '') {
          html += `</tbody></table></div>`; // Close previous table and div
        }
        html += `
          <div class="transaction-group-header">${dateOnly}</div>
          <div class="table-responsive">
            <table class="table table-hover table-striped table-sm">
              <thead>
                <tr>
                  <th>เวลา</th>
                  <th>ประเภท</th>
                  <th>ยอดเงิน</th>
                  <th>กระเป๋า</th>
                  <th>ชื่อรายการ</th>
                  <th>หมวดหมู่</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody>
        `;
        currentGroupDate = dateOnly;
      }

      const timeOnly = txDate.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Bangkok' });
      const amountColorClass = tx.Type === 'Income' ? 'text-success' : (tx.Type === 'Expense' ? 'text-danger' : 'text-primary');
      const walletDisplay = tx.Type === 'Transfer'
        ? `${tx.SourceWalletName} <i class="bi bi-arrow-right"></i> ${tx.DestinationWalletName}`
        : tx.SourceWalletName;
      const categoryDisplay = tx.Type !== 'Transfer'
        ? `<span style="color:${tx.CategoryColor};"><i class="${tx.CategoryIcon}"></i> ${tx.CategoryName}</span>`
        : 'N/A';

      html += `
        <tr>
          <td>${timeOnly}</td>
          <td>${tx.Type === 'Income' ? 'รายรับ' : (tx.Type === 'Expense' ? 'รายจ่าย' : 'โอนเงิน')}</td>
          <td class="${amountColorClass}">${formatCurrency(tx.Amount, allWallets.find(w => w.ID === tx.SourceWalletID)?.Currency || 'THB')}</td>
          <td>${walletDisplay}</td>
          <td>${tx.ItemName}</td>
          <td>${categoryDisplay}</td>
          <td>
            <button class="btn btn-sm btn-info me-2" onclick="showTransactionDetails('${tx.ID}')"><i class="bi bi-eye"></i></button>
            <button class="btn btn-sm btn-warning me-2" onclick="editTransaction('${tx.ID}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger" onclick="confirmDeleteTransaction('${tx.ID}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `;
    });

    if (transactionsToRender.length > 0) {
      html += `</tbody></table></div>`; // Close last table and div
    }
    transactionListDiv.innerHTML = html;
  }

  const transactionDetailsModal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
  const transactionDetailsContent = document.getElementById('transactionDetailsContent');

  function showTransactionDetails(id) {
    const tx = allTransactions.find(t => t.ID === id);
    if (!tx) {
      showMessage('ไม่พบข้อมูล', 'ไม่พบรายละเอียดธุรกรรมนี้');
      return;
    }

    const tagsHtml = tx.TagsData.map(tag => `<span class="badge me-1" style="background-color:${tag.Color};">${tag.Name}</span>`).join('');
    const imagesHtml = tx.ImagePaths && tx.ImagePaths.length > 0
      ? tx.ImagePaths.split(',').map(imgId => `<img src="https://drive.google.com/thumbnail?id=${imgId}" class="img-thumbnail me-2 mb-2" style="max-width: 100px; max-height: 100px;" onclick="window.open('https://drive.google.com/uc?id=${imgId}', '_blank')">`).join('')
      : 'ไม่มีรูปภาพ';

    const walletDisplay = tx.Type === 'Transfer'
      ? `<p><strong>กระเป๋าต้นทาง:</strong> ${tx.SourceWalletName}</p><p><strong>กระเป๋าปลายทาง:</strong> ${tx.DestinationWalletName}</p>`
      : `<p><strong>กระเป๋า:</strong> ${tx.SourceWalletName}</p>`;
    const categoryDisplay = tx.Type !== 'Transfer'
      ? `<p><strong>หมวดหมู่:</strong> <span style="color:${tx.CategoryColor};"><i class="${tx.CategoryIcon}"></i> ${tx.CategoryName} (${tx.CategoryType === 'Income' ? 'รายรับ' : 'รายจ่าย'})</span></p>`
      : '';

    transactionDetailsContent.innerHTML = `
      <p><strong>ประเภท:</strong> ${tx.Type === 'Income' ? 'รายรับ' : (tx.Type === 'Expense' ? 'รายจ่าย' : 'โอนเงิน')}</p>
      <p><strong>วันที่-เวลา:</strong> ${formatDate(tx.Timestamp)}</p>
      <p><strong>จำนวนเงิน:</strong> <span class="${tx.Type === 'Income' ? 'text-success' : (tx.Type === 'Expense' ? 'text-danger' : 'text-primary')}">${formatCurrency(tx.Amount, allWallets.find(w => w.ID === tx.SourceWalletID)?.Currency || 'THB')}</span></p>
      ${walletDisplay}
      ${categoryDisplay}
      <p><strong>ชื่อรายการ:</strong> ${tx.ItemName || '-'}</p>
      <p><strong>แท็ก:</strong> ${tagsHtml || '-'}</p>
      <p><strong>บันทึกช่วยจำ:</strong> ${tx.Memo || '-'}</p>
      <p><strong>รูปภาพ:</strong></p>
      <div class="flex flex-wrap">${imagesHtml}</div>
    `;
    transactionDetailsModal.show();
  }

  function editTransaction(id) {
    const tx = allTransactions.find(t => t.ID === id);
    if (tx) {
      transactionIdInput.value = tx.ID;
      document.getElementById('transactions-tab').click(); // Switch to transactions tab

      // Set transaction type radio
      document.querySelector(`input[name="transactionType"][value="${tx.Type}"]`).checked = true;
      // Manually trigger change to update UI visibility
      document.querySelector(`input[name="transactionType"][value="${tx.Type}"]`).dispatchEvent(new Event('change'));

      sourceWalletSelect.value = tx.SourceWalletID;
      destinationWalletSelect.value = tx.DestinationWalletID;
      categorySelect.value = tx.CategoryID;
      amountInput.value = tx.Amount;
      itemNameInput.value = tx.ItemName;

      // Set datetime input (convert from UTC+7 to local for input type datetime-local)
      const txDate = new Date(tx.Timestamp); // This is already in UTC+7
      const localOffset = txDate.getTimezoneOffset() * 60000; // Get local offset in ms
      const localDateTime = new Date(txDate.getTime() - localOffset); // Adjust to local time
      transactionDateTimeInput.value = localDateTime.toISOString().slice(0, 16);


      // Set selected tags
      Array.from(tagsSelect.options).forEach(option => {
        option.selected = tx.Tags && tx.Tags.split(',').includes(option.value);
      });

      // Set existing images
      existingImagePaths = tx.ImagePaths ? tx.ImagePaths.split(',') : [];
      uploadedImageFiles = []; // Clear any newly selected files
      imageUploadInput.value = ''; // Clear file input
      renderImagePreviews();

      memoInput.value = tx.Memo;

      transactionForm.querySelector('button[type="submit"]').innerText = 'อัปเดตธุรกรรม';
      cancelTransactionEditBtn.classList.remove('hidden');
    }
  }

  function confirmDeleteTransaction(id) {
    showConfirmation('คุณแน่ใจหรือไม่ที่ต้องการลบรายการธุรกรรมนี้?', async () => {
      showLoading();
      try {
        await callAppScript('deleteTransaction', [id]);
        showMessage('สำเร็จ', 'ลบรายการธุรกรรมเรียบร้อยแล้ว');
        loadAllData();
      } catch (error) {
        handleError(error);
      } finally {
        hideLoading();
      }
    });
  }

  // --- Transaction Search ---
  const transactionSearchForm = document.getElementById('transactionSearchForm');
  const searchKeywordInput = document.getElementById('searchKeyword');
  const searchStartDateInput = document.getElementById('searchStartDate');
  const searchEndDateInput = document.getElementById('searchEndDate');
  const searchCategoriesCheckboxesDiv = document.getElementById('searchCategoriesCheckboxes');
  const searchWalletsCheckboxesDiv = document.getElementById('searchWalletsCheckboxes');
  const searchTagsCheckboxesDiv = document.getElementById('searchTagsCheckboxes');
  const resetSearchBtn = document.getElementById('resetSearchBtn');

  function populateSearchFilters() {
    // Categories
    searchCategoriesCheckboxesDiv.innerHTML = '';
    allCategories.forEach(cat => {
      searchCategoriesCheckboxesDiv.innerHTML += `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${cat.ID}" id="searchCategory_${cat.ID}" checked>
          <label class="form-check-label" for="searchCategory_${cat.ID}">${cat.Name}</label>
        </div>
      `;
    });

    // Wallets
    searchWalletsCheckboxesDiv.innerHTML = '';
    allWallets.forEach(wallet => {
      searchWalletsCheckboxesDiv.innerHTML += `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${wallet.ID}" id="searchWallet_${wallet.ID}" checked>
          <label class="form-check-label" for="searchWallet_${wallet.ID}">${wallet.Name}</label>
        </div>
      `;
    });

    // Tags
    searchTagsCheckboxesDiv.innerHTML = '';
    allTags.forEach(tag => {
      searchTagsCheckboxesDiv.innerHTML += `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${tag.ID}" id="searchTag_${tag.ID}" checked>
          <label class="form-check-label" for="searchTag_${tag.ID}">${tag.Name}</label>
        </div>
      `;
    });
  }

  transactionSearchForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();

    const selectedCategoryIds = Array.from(searchCategoriesCheckboxesDiv.querySelectorAll('input:checked')).map(cb => cb.value);
    const selectedWalletIds = Array.from(searchWalletsCheckboxesDiv.querySelectorAll('input:checked')).map(cb => cb.value);
    const selectedTagIds = Array.from(searchTagsCheckboxesDiv.querySelectorAll('input:checked')).map(cb => cb.value);

    const filters = {
      keyword: searchKeywordInput.value,
      startDate: searchStartDateInput.value,
      endDate: searchEndDateInput.value,
      categoryIds: selectedCategoryIds,
      walletIds: selectedWalletIds,
      tagIds: selectedTagIds
    };

    try {
      const searchResults = await callAppScript('searchTransactions', [filters]);
      renderTransactions(searchResults);
    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  });

  resetSearchBtn.addEventListener('click', () => {
    transactionSearchForm.reset();
    populateSearchFilters(); // Re-check all checkboxes
    renderTransactions(allTransactions); // Show all transactions again
  });


  // --- Overview Tab ---
  const totalOverallBalanceElem = document.getElementById('totalOverallBalance');
  const summaryDailyIncomeElem = document.getElementById('summaryDailyIncome');
  const summaryDailyExpenseElem = document.getElementById('summaryDailyExpense');
  const summaryDailyTransferElem = document.getElementById('summaryDailyTransfer');
  const top5ExpensesListElem = document.getElementById('top5ExpensesList');
  const walletBalancesListElem = document.getElementById('walletBalancesList');
  const latestTransactionsListElem = document.getElementById('latestTransactionsList');

  const currentMonthYearElem = document.getElementById('currentMonthYear');
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const calendarGridElem = document.getElementById('calendarGrid');
  const calendarWalletFilter = document.getElementById('calendarWalletFilter');

  const dailyTransactionsModal = new bootstrap.Modal(document.getElementById('dailyTransactionsModal'));
  const dailyTransactionsDateElem = document.getElementById('dailyTransactionsDate');
  const dailyTransactionsListElem = document.getElementById('dailyTransactionsList');

  // Calendar navigation
  prevMonthBtn.addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    loadOverviewData();
  });
  nextMonthBtn.addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    loadOverviewData();
  });
  calendarWalletFilter.addEventListener('change', () => {
    loadOverviewData();
  });

  async function loadOverviewData(period = 'daily') {
    showLoading();
    try {
      const selectedWalletId = calendarWalletFilter.value || null;
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth(); // 0-11

      const overviewData = await callAppScript('getOverviewData', [selectedWalletId, year, month]);
      console.log('Overview Data:', overviewData);

      // Update summaryByType buttons
      document.querySelectorAll('.btn-sm.btn-outline-primary').forEach(btn => {
        if (btn.onclick.toString().includes(`'${period}'`)) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Part 1.0: Total Overall Balance
      totalOverallBalanceElem.innerText = formatCurrency(overviewData.totalOverallBalance, 'THB'); // Assuming THB as base for total

      // Part 1.1: Summary by Type (Daily/Weekly/Monthly)
      summaryDailyIncomeElem.innerText = formatCurrency(overviewData.summaryByType[period].income, 'THB');
      summaryDailyExpenseElem.innerText = formatCurrency(overviewData.summaryByType[period].expense, 'THB');
      summaryDailyTransferElem.innerText = formatCurrency(overviewData.summaryByType[period].transfer, 'THB');

      // Part 1.2: Top 5 Expenses
      if (overviewData.top5Expenses.length > 0) {
        top5ExpensesListElem.innerHTML = overviewData.top5Expenses.map(item =>
          `<li>${item.category}: <span class="text-danger">${formatCurrency(item.total, 'THB')}</span></li>`
        ).join('');
      } else {
        top5ExpensesListElem.innerHTML = '<li>- ไม่มีข้อมูล -</li>';
      }

      // Part 2: Wallet Balances
      if (overviewData.walletBalances.length > 0) {
        walletBalancesListElem.innerHTML = overviewData.walletBalances.map(wallet => `
          <div class="flex items-center mb-2">
            <i class="${wallet.Icon} text-xl me-2" style="color:${wallet.Color};"></i>
            <span class="font-medium">${wallet.Name}:</span>
            <span class="ms-auto font-bold">${formatCurrency(wallet.CurrentBalance, wallet.Currency)}</span>
          </div>
        `).join('');
      } else {
        walletBalancesListElem.innerHTML = '<p>- ไม่มีข้อมูล -</p>';
      }

      // Part 3: Latest Transactions
      if (overviewData.latestTransactions.length > 0) {
        latestTransactionsListElem.innerHTML = `
          <ul class="list-unstyled">
            ${overviewData.latestTransactions.map(tx => {
              const amountColorClass = tx.Type === 'Income' ? 'text-success' : (tx.Type === 'Expense' ? 'text-danger' : 'text-primary');
              const walletCurrency = allWallets.find(w => w.ID === tx.SourceWalletID)?.Currency || 'THB';
              return `
                <li class="mb-1">
                  <span class="text-sm text-gray-600">${new Date(tx.Timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })}:</span>
                  <span class="font-medium">${tx.ItemName}</span>
                  <span class="float-end ${amountColorClass}">${formatCurrency(tx.Amount, walletCurrency)}</span>
                </li>
              `;
            }).join('')}
          </ul>
        `;
      } else {
        latestTransactionsListElem.innerHTML = '<p>- ไม่มีข้อมูล -</p>';
      }

      // Part 4: Calendar
      renderCalendar(overviewData.calendarData);

      // Populate calendar wallet filter dropdown
      calendarWalletFilter.innerHTML = '<option value="">ทุกกระเป๋า</option>';
      allWallets.forEach(wallet => {
        const option = document.createElement('option');
        option.value = wallet.ID;
        option.innerText = wallet.Name;
        calendarWalletFilter.appendChild(option);
      });
      if (selectedWalletId) {
        calendarWalletFilter.value = selectedWalletId;
      }

    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  }

  function renderCalendar(calendarData) {
    calendarGridElem.innerHTML = '';
    const today = new Date();
    const currentYear = currentCalendarDate.getFullYear();
    const currentMonth = currentCalendarDate.getMonth(); // 0-11

    currentMonthYearElem.innerText = currentCalendarDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });

    const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
    const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
    const numDaysInMonth = lastDayOfMonth.getDate();

    // Adjust first day of month to start on Monday (0=Sunday, 1=Monday, ..., 6=Saturday)
    let startDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday
    if (startDayOfWeek === 0) startDayOfWeek = 7; // Convert Sunday (0) to 7 for easier Monday-start logic
    startDayOfWeek--; // Adjust to 0-indexed where Monday is 0

    // Add empty days for the start of the week
    for (let i = 0; i < startDayOfWeek; i++) {
      const emptyDay = document.createElement('div');
      emptyDay.classList.add('calendar-day', 'empty');
      calendarGridElem.appendChild(emptyDay);
    }

    // Add days of the month
    for (let day = 1; day <= numDaysInMonth; day++) {
      const date = new Date(currentYear, currentMonth, day);
      const dateKey = Utilities.formatDate(date, 'Asia/Bangkok', 'yyyy-MM-dd'); // Use App Script's date format
      const dailySummary = calendarData[dateKey] || { income: 0, expense: 0 };

      const dayDiv = document.createElement('div');
      dayDiv.classList.add('calendar-day');
      if (date.toDateString() === today.toDateString()) {
        dayDiv.classList.add('current-day');
      }

      dayDiv.innerHTML = `
        <div class="calendar-day-date">${day}</div>
        <div>
          ${dailySummary.income > 0 ? `<div class="calendar-income">+${dailySummary.income.toFixed(2)}</div>` : ''}
          ${dailySummary.expense > 0 ? `<div class="calendar-expense">-${dailySummary.expense.toFixed(2)}</div>` : ''}
        </div>
      `;
      dayDiv.addEventListener('click', () => showDailyTransactions(dateKey, calendarWalletFilter.value));
      calendarGridElem.appendChild(dayDiv);
    }
  }

  async function showDailyTransactions(dateString, filterWalletId) {
    showLoading();
    try {
      const transactions = await callAppScript('getTransactionsForDate', [dateString, filterWalletId]);
      dailyTransactionsDateElem.innerText = new Date(dateString).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
      dailyTransactionsListElem.innerHTML = '';

      if (transactions.length === 0) {
        dailyTransactionsListElem.innerHTML = '<p class="text-center text-gray-500">ไม่มีรายการธุรกรรมสำหรับวันนี้</p>';
      } else {
        let html = `
          <div class="table-responsive">
            <table class="table table-hover table-striped table-sm">
              <thead>
                <tr>
                  <th>เวลา</th>
                  <th>ประเภท</th>
                  <th>ยอดเงิน</th>
                  <th>กระเป๋า</th>
                  <th>ชื่อรายการ</th>
                  <th>หมวดหมู่</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody>
        `;
        transactions.forEach(tx => {
          const timeOnly = new Date(tx.Timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Bangkok' });
          const amountColorClass = tx.Type === 'Income' ? 'text-success' : (tx.Type === 'Expense' ? 'text-danger' : 'text-primary');
          const walletDisplay = tx.Type === 'Transfer'
            ? `${tx.SourceWalletName} <i class="bi bi-arrow-right"></i> ${tx.DestinationWalletName}`
            : tx.SourceWalletName;
          const categoryDisplay = tx.Type !== 'Transfer'
            ? `<span style="color:${tx.CategoryColor};"><i class="${tx.CategoryIcon}"></i> ${tx.CategoryName}</span>`
            : 'N/A';
          const walletCurrency = allWallets.find(w => w.ID === tx.SourceWalletID)?.Currency || 'THB';

          html += `
            <tr>
              <td>${timeOnly}</td>
              <td>${tx.Type === 'Income' ? 'รายรับ' : (tx.Type === 'Expense' ? 'รายจ่าย' : 'โอนเงิน')}</td>
              <td class="${amountColorClass}">${formatCurrency(tx.Amount, walletCurrency)}</td>
              <td>${walletDisplay}</td>
              <td>${tx.ItemName}</td>
              <td>${categoryDisplay}</td>
              <td>
                <button class="btn btn-sm btn-info me-2" onclick="showTransactionDetails('${tx.ID}')"><i class="bi bi-eye"></i></button>
                <button class="btn btn-sm btn-warning me-2" onclick="editTransaction('${tx.ID}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-danger" onclick="confirmDeleteTransaction('${tx.ID}')"><i class="bi bi-trash"></i></button>
              </td>
            </tr>
          `;
        });
        html += `</tbody></table></div>`;
        dailyTransactionsListElem.innerHTML = html;
      }
      dailyTransactionsModal.show();
    } catch (error) {
      handleError(error);
    } finally {
      hideLoading();
    }
  }


  // --- Initial Load ---
  // Ensure google.script.run is available before calling
  window.addEventListener('load', () => {
    // We no longer rely on google.script.run directly from the frontend
    // The check below is for when the script is run in a Google Apps Script environment (e.g., for testing)
    // For the PWA on GitHub Pages, APP_SCRIPT_WEB_APP_URL must be set correctly.
    if (APP_SCRIPT_WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE' || !APP_SCRIPT_WEB_APP_URL) {
      showMessage('ข้อผิดพลาด', 'โปรดตั้งค่า APP_SCRIPT_WEB_APP_URL ในโค้ด frontend.html ก่อนใช้งาน');
      hideLoading();
      return;
    }
    loadAllData();

    // Register Service Worker for PWA capabilities
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/yord-krapook-pwa/service-worker.js')
        .then(registration => {
          console.log('Service Worker registered:', registration);
        })
        .catch(error => {
          console.error('Service Worker registration failed:', error);
        });
    }
  });

  // Polyfill for Utilities.formatDate equivalent in client-side JS (simplified for display)
  // This is a basic formatter. For full timezone accuracy, server-side (App Script) is preferred.
  // This is used for calendar display, where exact UTC+7 is less critical than consistent formatting.
  const Utilities = {
    formatDate: function(date, timeZone, format) {
      const d = new Date(date);
      // For simplicity, this client-side version assumes the date object is already in the correct timezone or is local.
      // The App Script `formatDate` handles timezone conversion accurately.
      // This client-side helper is mostly for calendar date keys.
      const year = d.getFullYear();
      const month = (d.getMonth() + 1).toString().padStart(2, '0');
      const day = d.getDate().toString().padStart(2, '0');
      const hours = d.getHours().toString().padStart(2, '0');
      const minutes = d.getMinutes().toString().padStart(2, '0');
      const seconds = d.getSeconds().toString().padStart(2, '0');

      if (format === 'yyyy-MM-dd HH:mm:ss') {
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      } else if (format === 'yyyy-MM-dd') {
        return `${year}-${month}-${day}`;
      }
      return d.toISOString(); // Fallback
    }
  };

</script>
</body>
</html>
